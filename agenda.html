<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reserva tu cita Â· Nocodia</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <style>
    body{
      font-family:Arial, sans-serif;
      background:#f7f7f7;
      margin:0;
      padding:20px;
    }
    .card{
      max-width:480px;
      margin:20px auto;
      background:#ffffff;
      padding:24px;
      border-radius:12px;
      box-shadow:0 4px 16px rgba(0,0,0,.08);
    }
    h2,h3{ margin-top:0; }
    label{
      display:block;
      margin-top:14px;
      font-weight:bold;
    }
    input{
      width:100%;
      padding:10px;
      margin-top:6px;
      border:1px solid #d1d5db;
      border-radius:6px;
      box-sizing:border-box;
      font-size:14px;
    }
    .slots-container{ margin-top:10px; }
    .slot{
      padding:10px 12px;
      border:1px solid #d1d5db;
      border-radius:8px;
      margin-top:8px;
      cursor:pointer;
      background:#f9fafb;
    }
    .slot:hover{ background:#eef2ff; }
    .slot.active{
      background:#dbeafe;
      border-color:#2563eb;
      font-weight:bold;
    }
    button{
      margin-top:18px;
      width:100%;
      padding:12px;
      border:none;
      border-radius:8px;
      background:#111827;
      color:#ffffff;
      font-weight:bold;
      font-size:15px;
      cursor:pointer;
    }
    button:disabled{ opacity:.6; }
    .msg{ margin-top:10px; font-size:14px; }
    .msg.ok{ color:#0a7d28; }
    .msg.err{ color:#b91c1c; }
    hr{ margin:20px 0; }
  </style>
</head>

<body>
  <div class="card">
    <h2>Reserva tu cita</h2>

    <label>Elige la fecha *</label>
    <input id="date" type="date"/>

    <div id="slots" class="slots-container"></div>

    <hr>

    <h3>Datos del paciente</h3>

    <form id="form">
      <input type="hidden" id="doctor_id">
      <input type="hidden" id="slot_start">
      <input type="hidden" id="slot_end">

      <label>Nombre completo *</label>
      <input id="name" required>

      <label>CÃ©dula *</label>
      <input id="national_id" maxlength="10" required>

      <label>TelÃ©fono *</label>
      <input id="phone" required>

      <label>Email (opcional)</label>
      <input id="email" type="email">

      <button type="submit">Reservar cita</button>
      <div id="msg" class="msg"></div>
    </form>
  </div>

<script>
const API = "https://nocodia-agenda-worker-v2.jraul-garcia.workers.dev";
const DOCTOR_ID = "TEST";
document.getElementById("doctor_id").value = DOCTOR_ID;

// ---------- formato 09:00 ----------
function formatTime(iso){
  const d = new Date(iso);
  return d.toLocaleTimeString("es-EC",{hour:"2-digit",minute:"2-digit",hour12:false});
}

// ---------- cargar horarios ----------
document.getElementById("date").addEventListener("change", async()=>{
  const date = document.getElementById("date").value;
  const box  = document.getElementById("slots");
  box.innerHTML = "Cargando horariosâ€¦";

  document.getElementById("slot_start").value="";
  document.getElementById("slot_end").value="";

  const res = await fetch(`${API}/availability`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      doctor_id:DOCTOR_ID,
      date,
      timezone:"America/Guayaquil"
    })
  });

  const data = await res.json();
  box.innerHTML = "";

  if(!res.ok || data.error){
    box.innerHTML = "Error cargando horarios";
    return;
  }

  data.slots.forEach(s=>{
    if(s.status!=="available") return;

    const div = document.createElement("div");
    div.className="slot";

    // ðŸ”¥ AQUI ESTA LA DIFERENCIA
    div.innerText = `${formatTime(s.start)} â†’ ${formatTime(s.end)}`;

    div.onclick=()=>{
      document.querySelectorAll(".slot").forEach(x=>x.classList.remove("active"));
      div.classList.add("active");

      document.getElementById("slot_start").value=s.start; // ISO â†’ al Worker
      document.getElementById("slot_end").value=s.end;
    };

    box.appendChild(div);
  });

  if(!box.innerHTML) box.innerHTML="No hay horarios disponibles.";
});

// ---------- reservar ----------
document.getElementById("form").addEventListener("submit", async(e)=>{
  e.preventDefault();

  const payload={
    doctor_id:DOCTOR_ID,
    slot_start:document.getElementById("slot_start").value,
    slot_end:document.getElementById("slot_end").value,
    patient:{
      name:document.getElementById("name").value.trim(),
      national_id:document.getElementById("national_id").value.trim(),
      phone:document.getElementById("phone").value.trim(),
    }
  };

  const email=document.getElementById("email").value.trim();
  if(email) payload.patient.email=email;

  const res=await fetch(`${API}/book`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });

  const data=await res.json();
  const msg=document.getElementById("msg");

  if(!res.ok||data.error){
    msg.className="msg err";
    msg.innerText=data.error||"No se pudo reservar.";
  }else{
    msg.className="msg ok";
    msg.innerText="Cita reservada correctamente.";
  }
});
</script>
</body>
</html>
