<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Nocodia ‚Äî Configurar agenda m√©dica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 40px auto;
      background: #fff;
      padding: 24px;
      border-radius: 8px;
    }
    h1 {
      margin-top: 0;
    }
    label {
      display: block;
      margin-top: 16px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .dias {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-top: 10px;
      text-align: center;
    }

    .dias label {
      font-weight: normal;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 13px;
      white-space: nowrap;
    }

    @media(max-width: 480px){
      .dias{
        grid-template-columns: repeat(4,1fr);
      }
    }

    button {
      margin-top: 24px;
      width: 100%;
      padding: 14px;
      font-size: 16px;
      background: #111827;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #000;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .nota {
      margin-top: 12px;
      font-size: 13px;
      color: #555;
    }

    .step {
      display: none;
    }
    .step.active {
      display: block;
    }

    .success-box {
      background: #d1fae5;
      border: 2px solid #10b981;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .success-box h2 {
      color: #047857;
      margin-top: 0;
    }
    .bot-link {
      background: #111827;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      text-decoration: none;
      display: inline-block;
      margin: 10px 0;
      font-weight: bold;
    }
    .bot-link:hover {
      background: #000;
    }
  </style>
</head>

<body>
  <div class="container">
    
    <!-- PASO 1: Formulario de datos -->
    <div id="step1" class="step active">
      <h1>Configura tu agenda de atenci√≥n</h1>

      <form id="agenda-form">
        <label>Nombre completo</label>
        <input id="nombre" type="text" required />

        <label>Especialidad</label>
        <input id="especialidad" type="text" required />

        <label>Email</label>
        <input id="email" type="email" required />

        <label>Tel√©fono</label>
        <input id="phone" type="tel" required />

        <label>Direcci√≥n del consultorio</label>
        <input id="address" type="text" required />

        <label>D√≠as de atenci√≥n</label>
        <div class="dias">
          <label><input type="checkbox" name="dias" value="lunes"> Lun</label>
          <label><input type="checkbox" name="dias" value="martes"> Mar</label>
          <label><input type="checkbox" name="dias" value="miercoles"> Mi√©</label>
          <label><input type="checkbox" name="dias" value="jueves"> Jue</label>
          <label><input type="checkbox" name="dias" value="viernes"> Vie</label>
          <label><input type="checkbox" name="dias" value="sabado"> S√°b</label>
          <label><input type="checkbox" name="dias" value="domingo"> Dom</label>
        </div>

        <label>Hora de inicio</label>
        <input id="hora_inicio" type="time" value="08:00" required />

        <label>Hora de fin</label>
        <input id="hora_fin" type="time" value="18:00" required />

        <label>Duraci√≥n de cada cita (minutos)</label>
        <select id="duracion">
          <option value="15">15</option>
          <option value="20">20</option>
          <option value="30" selected>30</option>
          <option value="45">45</option>
          <option value="60">60</option>
        </select>
        <label>Costo de consulta (USD)</label>
<input id="precio" type="number" step="0.01" value="35" required />

        


        <button type="submit" id="btnContinue">Continuar</button>

        <div class="nota">
          Podr√°s cambiar tus horarios f√°cilmente desde Telegram cuando lo necesites.
        </div>
      </form>
    </div>

    <!-- PASO 2: Conectar Google Calendar -->
    <div id="step2" class="step">
      <h1>‚úÖ Datos guardados</h1>
      <p>Ahora conecta tu Google Calendar para que tus pacientes vean tu disponibilidad real.</p>
      
      <button id="btnGoogle" onclick="connectGoogle()">
        üîó Conectar Google Calendar
      </button>

      <div class="nota" style="margin-top: 20px;">
        Se abrir√° una ventana de Google para autorizar el acceso a tu calendario.
      </div>
    </div>

    <!-- PASO 3: √âxito -->
    <div id="step3" class="step">
      <div class="success-box">
        <h2>üéâ ¬°Tu bot est√° listo!</h2>
        <p>Comparte este enlace con tus pacientes:</p>
        <a id="botLink" class="bot-link" href="#" target="_blank"></a>
        
        <p style="margin-top: 30px; font-size: 14px;">
          Tambi√©n puedes gestionar tu agenda desde Telegram:<br>
          ‚Ä¢ Crear vacaciones<br>
          ‚Ä¢ Modificar horarios<br>
          ‚Ä¢ Bloquear d√≠as<br>
          ‚Ä¢ Ver tus citas
        </p>
      </div>
    </div>

  </div>

  <script>
    const WORKER_URL = "https://nocodia-agenda-worker-v2.jraul-garcia.workers.dev";
    
    let doctorData = {};

    // PASO 1: Guardar datos b√°sicos
    document.getElementById("agenda-form").addEventListener("submit", async function(e) {
      e.preventDefault();

      const diasSeleccionados = Array.from(
        document.querySelectorAll("input[name='dias']:checked")
      ).map(d => d.value);

      if (diasSeleccionados.length === 0) {
        alert("Selecciona al menos un d√≠a de atenci√≥n");
        return;
      }

      doctorData = {
        name: document.getElementById("nombre").value,
        specialty: document.getElementById("especialidad").value,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value,
        address: document.getElementById("address").value,
        office_hours: diasSeleccionados.join(", "),
        work_start: document.getElementById("hora_inicio").value,
        work_end: document.getElementById("hora_fin").value,
        slot_duration: parseInt(document.getElementById("duracion").value),
        consultation_price: parseFloat(document.getElementById("precio").value)
      };

      // Guardar en localStorage
      localStorage.setItem("doctorData", JSON.stringify(doctorData));

      // Ir a paso 2
      document.getElementById("step1").classList.remove("active");
      document.getElementById("step2").classList.add("active");
    });

    // PASO 2: Conectar Google
    function connectGoogle() {
      const data = localStorage.getItem("doctorData");
      if (!data) {
        alert("Error: datos no encontrados");
        return;
      }

      const CLIENT_ID = "579482042972-tb17e0888ujg6oh920au3r33sv5kn2j9.apps.googleusercontent.com";
      const REDIRECT_URI = "https://nocodia-agenda-q23ght6wb-nocodia-projects.vercel.app/oauth-callback.html";
      const SCOPE = "https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/userinfo.email";

      const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
        `client_id=${CLIENT_ID}&` +
        `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
        `response_type=code&` +
        `scope=${encodeURIComponent(SCOPE)}&` +
        `access_type=offline&` +
        `prompt=consent`;

      window.location.href = authUrl;
    }

    // PASO 3: Mostrar resultado (se llama desde oauth-callback.html)
    window.showSuccess = function(providerCode) {
      document.getElementById("step2").classList.remove("active");
      document.getElementById("step3").classList.add("active");

      const botLink = `https://t.me/nocodia_agenda_bot?start=${providerCode}`;
      document.getElementById("botLink").href = botLink;
      document.getElementById("botLink").textContent = botLink;

      localStorage.removeItem("doctorData");
    };
  </script>
</body>
</html>

